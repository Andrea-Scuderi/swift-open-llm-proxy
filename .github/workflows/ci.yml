name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-linux:
    name: Test (Linux / Swift 6.2.3)
    runs-on: ubuntu-latest
    container: swift:6.2.3-noble

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore SPM build cache
        uses: actions/cache@v4
        with:
          path: .build
          key: spm-linux-swift6.2.3-${{ hashFiles('Package.resolved') }}
          restore-keys: spm-linux-swift6.2.3-

      - name: Build (with tests)
        run: swift build --build-tests

      - name: Run tests
        run: swift test --skip-build

  test-macos:
    name: Test (macOS 15 / Xcode 16.2 / Swift 6.0)
    runs-on: macos-15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode 16.2
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "16.2"

      - name: Restore SPM build cache
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Caches/org.swift.swiftpm
          key: spm-macos-swift6.0-${{ hashFiles('Package.resolved') }}
          restore-keys: spm-macos-swift6.0-

      - name: Build (with tests)
        run: swift build --build-tests

      - name: Run tests
        run: swift test --skip-build

  release-build:
    name: Release Build (macOS 15 / Xcode 16.2)
    runs-on: macos-15
    if: github.event_name == 'push'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode 16.2
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "16.2"

      - name: Restore SPM release build cache
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Caches/org.swift.swiftpm
          key: spm-macos-release-swift6.0-${{ hashFiles('Package.resolved') }}
          restore-keys: spm-macos-release-swift6.0-

      - name: Build release binary
        run: swift build -c release
